<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ì¦ì‹œ í´ë¡  - ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„ í”Œë«í¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.39/dist/webllm.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” ë° í°íŠ¸ ì„¤ì • (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
        body {
            font-family: 'Naver NanumGothic', 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7; /* ë„¤ì´ë²„ ë°°ê²½ìƒ‰ê³¼ ìœ ì‚¬ */
            color: #1c1c1c;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            background-color: #fff;
            border-bottom: 1px solid #ebebeb;
            padding: 10px 0;
        }
        .header-content {
            width: 1080px; /* ë„¤ì´ë²„ í‘œì¤€ ë„ˆë¹„ */
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo a {
            font-size: 24px;
            font-weight: bold;
            color: #008850; /* ë„¤ì´ë²„ ê·¸ë¦° */
            text-decoration: none;
        }
        nav a {
            margin-left: 20px;
            text-decoration: none;
            color: #1c1c1c;
            font-size: 14px;
        }
        nav a:hover {
            color: #008850;
        }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ (LLM ì±—ë´‡ì„ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜í•˜ê¸° ìœ„í•´ grid ì‚¬ìš©) */
        .main-content {
            width: 1080px;
            margin: 20px auto;
            display: grid; 
            grid-template-columns: 2fr 1fr; /* í¬ë¡¤ë§ ë°ì´í„°(2)ì™€ ì±—ë´‡(1) ë¹„ìœ¨ */
            gap: 20px;
        }

        /* ì™¼ìª½ ì„¹ì…˜ (ê¸ˆìœµ ì§€ìˆ˜ ë° ì‹œê°€ì´ì•¡) */
        .left-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ì˜¤ë¥¸ìª½ ì„¹ì…˜ (LLM ì±—ë´‡) */
        .right-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            max-height: 80vh; 
            display: flex;
            flex-direction: column;
        }

        /* ê¸ˆìœµ ì§€ìˆ˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .index-cards {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .index-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            flex: 1;
        }
        .index-name {
            font-size: 16px;
            color: #666;
            margin-bottom: 5px;
        }
        .index-value {
            font-size: 24px;
            font-weight: bold;
            color: #1c1c1c;
        }
        .index-change {
            font-size: 14px;
            margin-top: 5px;
        }
        .text-up { color: #d80000; } /* ë¹¨ê°„ìƒ‰ (ìƒìŠ¹) */
        .text-down { color: #0059c4; } /* íŒŒë€ìƒ‰ (í•˜ë½) */
        .text-flat { color: #666; } /* íšŒìƒ‰ (ë³´í•©) */

        /* ì‹œê°€ì´ì•¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .market-sum-table-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow-x: auto; /* ëª¨ë°”ì¼ ëŒ€ì‘ì„ ìœ„í•œ ìŠ¤í¬ë¡¤ */
        }
        .market-sum-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .market-sum-table th, .market-sum-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: right;
            white-space: nowrap; /* ì…€ ë‚´ìš© ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        .market-sum-table th {
            background-color: #f7f7f7;
            font-weight: 500;
            color: #666;
            text-align: center;
        }
        .market-sum-table td:first-child {
            text-align: left; /* ì¢…ëª©ëª…ì€ ì™¼ìª½ ì •ë ¬ */
            font-weight: bold;
            color: #333;
        }
        .text-right { text-align: right !important; }

        /* LLM ì±—ë´‡ ìŠ¤íƒ€ì¼ */
        #llm-output {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
            font-size: 14px;
        }
        #llm-chat-form {
            display: flex;
            gap: 10px;
            margin-top: auto; /* í•˜ë‹¨ì— ê³ ì • */
        }
        #llm-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #llm-submit {
            padding: 8px 15px;
            border: none;
            background-color: #008850;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        #llm-submit:disabled {
            background-color: #a8a8a8;
        }
        /* ì±—ë´‡ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .user-message {
            color: #0059c4;
            font-weight: bold;
        }
        .llm-message {
            color: #008850;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo"><a href="#">ë„¤ì´ë²„ ì¦ì‹œ í´ë¡ </a></div>
            <nav>
                <a href="#">í™ˆ</a>
                <a href="#">ì‹œí™©</a>
                <a href="#">ë‰´ìŠ¤</a>
                <a href="#">ë§ˆì´ë°ì´í„°</a>
            </nav>
        </div>
    </header>

    <div class="main-content">
        
        <div class="left-section">
            
            <h2>ì£¼ìš” ê¸ˆìœµ ì§€ìˆ˜</h2>
            <div class="index-cards">
                <div id="index-kospi" class="index-card">
                    <div class="index-name">KOSPI</div>
                    <div class="index-value">...</div>
                    <div class="index-change">...</div>
                </div>
                <div id="index-kosdaq" class="index-card">
                    <div class="index-name">KOSDAQ</div>
                    <div class="index-value">...</div>
                    <div class="index-change">...</div>
                </div>
                <div id="index-dow" class="index-card">
                    <div class="index-name">Dow Jones</div>
                    <div class="index-value">...</div>
                    <div class="index-change">...</div>
                </div>
                <div id="index-nasdaq" class="index-card">
                    <div class="index-name">NASDAQ</div>
                    <div class="index-value">...</div>
                    <div class="index-change">...</div>
                </div>
            </div>

            <h2>ì½”ìŠ¤í”¼ ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª©</h2>
            <div class="market-sum-table-container">
                <p id="loading-status">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                <table class="market-sum-table" id="stock-market-sum-table" style="display: none;">
                    <thead>
                        <tr></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

        </div>

        <div class="right-section">
            <h2>LLM ê¸ˆìœµ ë¶„ì„ ì±—ë´‡ (TinyLlama On-Device)</h2>
            <div id="llm-output">
                <span class="llm-message">ëª¨ë¸ì„ ë¡œë“œí•˜ëŠ” ì¤‘... (ìµœëŒ€ 1ë¶„ ì†Œìš”)</span>
            </div>
            <form id="llm-chat-form">
                <input type="text" id="llm-input" placeholder="ëª¨ë¸ ë¡œë“œ ì™„ë£Œ í›„ ì§ˆë¬¸í•˜ì„¸ìš”." required disabled>
                <button type="submit" id="llm-submit" disabled>ë¶„ì„ ìš”ì²­</button>
            </form>
            <p id="llm-error-message" style="color: red; font-size: 12px; margin-top: 5px; display: none;"></p>
        </div>

    </div>
    
    <script>
        // -------------------------------------------------------------
        // 1. ì´ˆê¸° ì„¤ì • ë° WebLLM ì´ˆê¸°í™”
        // -------------------------------------------------------------
        
        // ğŸ”‘ On-Device LLM ì„¤ì •
        const engine = new webllm.Engine();
        const modelId = "TinyLlama-1.1B-Chat-v0.4-q4f32_1-MLC"; // ê°€ì¥ ê²½ëŸ‰í™”ëœ ëª¨ë¸ ì¤‘ í•˜ë‚˜
        let modelLoaded = false;

        const API_URL = 'http://api.chxtwo.kro.kr'; // ê¸°ì¡´ ë°±ì—”ë“œ API URL
        
        // LLM ìš”ì†Œ ì°¸ì¡°
        const llmChatForm = document.getElementById('llm-chat-form');
        const llmInput = document.getElementById('llm-input');
        const llmOutput = document.getElementById('llm-output');
        const llmSubmit = document.getElementById('llm-submit');
        const llmErrorMessage = document.getElementById('llm-error-message');
        
        function updateChatDisplay(role, message) {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<span class="${role}-message">${role === 'user' ? 'ë‚˜' : 'ë¶„ì„ê°€'}:</span> ${message}`;
            llmOutput.appendChild(messageElement);
            llmOutput.scrollTop = llmOutput.scrollHeight;
        }

        async function initializeWebLLM() {
            try {
                // ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ì§„í–‰ ìƒíƒœë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                const updateCallback = (progress) => {
                    llmOutput.innerHTML = `<span class="llm-message">ëª¨ë¸ ë¡œë“œ ì¤‘: ${progress.text} (${(progress.progress * 100).toFixed(1)}%)</span>`;
                };
                
                // ëª¨ë¸ ë¡œë“œ ì‹œì‘
                await engine.reload(modelId, { progressCallback: updateCallback });
                
                modelLoaded = true;
                llmOutput.innerHTML = `<span class="llm-message">âœ… ${modelId} ë¡œë“œ ì™„ë£Œ. ì§ˆë¬¸í•˜ì„¸ìš”.</span>`;
                llmInput.disabled = false;
                llmSubmit.disabled = false;
                llmInput.placeholder = "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...";
                llmInput.focus();

            } catch (error) {
                console.error("WebLLM ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                llmErrorMessage.textContent = `ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: ${error.message}. WebGPU ì§€ì› ë¸Œë¼ìš°ì €ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
                llmErrorMessage.style.display = 'block';
                llmOutput.innerHTML = `<span style="color:red;">âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨</span>`;
            }
        }


        // -------------------------------------------------------------
        // 2. í¬ë¡¤ë§ ë°ì´í„° ë¡œë“œ ë° í…Œì´ë¸” ê·¸ë¦¬ê¸° ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        // -------------------------------------------------------------
        
        async function loadStockMarketData() {
            const tableElement = document.getElementById('stock-market-sum-table');
            const statusElement = document.getElementById('loading-status');
            const tbody = tableElement.querySelector('tbody');
            const theadRow = tableElement.querySelector('thead tr');
            
            // ê¸°ì¡´ ì´ˆê¸° ë©”ì‹œì§€ ë³µì›
            const initialChatOutput = llmOutput.innerHTML;
            
            // ... (ë°ì´í„° ë¡œë“œ ë° í…Œì´ë¸” ìƒì„± ë¡œì§ì€ ì´ì „ ë‹µë³€ê³¼ ë™ì¼) ...
            
            statusElement.textContent = "ìµœì‹  ì‹œê°€ì´ì•¡ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...";
            statusElement.style.color = '#008850';
            tbody.innerHTML = '';
            theadRow.innerHTML = '';
            tableElement.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/api/stock/market-sum`);
                
                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.status} - ${errorJson.error || response.statusText}`);
                }
                
                const data = await response.json();
                if (!data || data.length === 0) {
                    statusElement.textContent = "ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í¬ë¡¤ë§ì„ ë¨¼ì € ì‹¤í–‰í•´ ì£¼ì„¸ìš”.";
                    statusElement.style.color = 'orange';
                    return;
                }

                // í…Œì´ë¸” í—¤ë” ìƒì„±
                const headers = Object.keys(data[0]);
                headers.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key;
                    theadRow.appendChild(th);
                });

                // LLMì—ê²Œ ì œê³µí•  ë°ì´í„°ë¥¼ í¬ë§·íŒ…
                let dataForLLM = "í˜„ì¬ ì½”ìŠ¤í”¼ ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© ë°ì´í„°:\n";
                dataForLLM += headers.join(' | ') + "\n";
                
                // í…Œì´ë¸” ë³¸ë¬¸ ìƒì„±
                data.forEach(item => {
                    const tr = document.createElement('tr');
                    let rowDataForLLM = [];

                    headers.forEach(key => {
                        const td = document.createElement('td');
                        let value = item[key];

                        if (value === undefined || value === null) {
                            td.textContent = '-';
                            rowDataForLLM.push('-');
                        } else {
                            if (key !== 'ì¢…ëª©ëª…' && key !== 'ë“±ë½ë¥ ') {
                                if (key === 'ì‹œê°€ì´ì•¡' || key === 'ìƒì¥ì£¼ì‹ìˆ˜' || key === 'í˜„ì¬ê°€' || key === 'ê±°ë˜ëŸ‰') {
                                    value = Math.round(parseFloat(value)).toLocaleString('ko-KR');
                                }
                            } else if (key === 'ë“±ë½ë¥ ' && typeof value === 'number') {
                                td.textContent = `${value}%`;
                                if (value > 0) td.classList.add('text-up');
                                else if (value < 0) td.classList.add('text-down');
                            }
                            td.textContent = value;
                            rowDataForLLM.push(item[key]); 
                        }
                        
                        if (key !== 'ì¢…ëª©ëª…') td.classList.add('text-right');
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                    dataForLLM += rowDataForLLM.join(' | ') + "\n";
                });

                statusElement.style.display = 'none';
                tableElement.style.display = 'table';
                
                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•˜ì—¬ ì±—ë´‡ ë¡œì§ì—ì„œ ì‚¬ìš©
                window.StockDataForLLM = dataForLLM; 

            } catch (error) {
                console.error("í¬ë¡¤ë§ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                statusElement.textContent = `ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                statusElement.style.color = 'red';
                tableElement.style.display = 'none';
                window.StockDataForLLM = "ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            } finally {
                llmOutput.innerHTML = initialChatOutput; // ì±—ë´‡ ì´ˆê¸° ë©”ì‹œì§€ ë³µêµ¬
            }
        }
        
        // -------------------------------------------------------------
        // 3. LLM ì±—ë´‡ ì¶”ë¡  ë¡œì§ (WebLLM ì‚¬ìš©)
        // -------------------------------------------------------------
        
        llmChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!modelLoaded) return; 

            const userPrompt = llmInput.value.trim();
            if (!userPrompt) return;
            
            updateChatDisplay('user', userPrompt);
            llmErrorMessage.style.display = 'none';

            llmInput.value = '';
            llmInput.disabled = true;
            llmSubmit.disabled = true;
            llmSubmit.textContent = 'ë¶„ì„ ì¤‘...';
            
            // WebLLMì˜ ì±„íŒ… ìŠ¤íŠ¸ë¦¼ì„ ë°›ì„ ì—˜ë¦¬ë¨¼íŠ¸
            const assistantMessageEl = document.createElement('div');
            assistantMessageEl.innerHTML = '<span class="llm-message">ë¶„ì„ê°€:</span> ';
            llmOutput.appendChild(assistantMessageEl);
            llmOutput.scrollTop = llmOutput.scrollHeight;
            
            // í¬ë¡¤ë§ ë°ì´í„°ë¥¼ í¬í•¨í•˜ì—¬ ì „ì²´ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
            const systemPrompt = `ë‹¹ì‹ ì€ ì½”ìŠ¤í”¼ ìƒìœ„ ì¢…ëª© ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ì ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”. ë°ì´í„°ëŠ” ${window.StockDataForLLM || "í˜„ì¬ ë¡œë”©ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."}`;
            
            try {
                // WebLLM ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œ
                const fullResponse = await engine.chat.completions.create({
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ],
                    stream: true,
                });
                
                let accumulatedText = '';
                for await (const chunk of fullResponse) {
                    const content = chunk.choices[0].delta.content || "";
                    accumulatedText += content;
                    assistantMessageEl.innerHTML = '<span class="llm-message">ë¶„ì„ê°€:</span> ' + accumulatedText;
                    llmOutput.scrollTop = llmOutput.scrollHeight;
                }
                
                // ì¶”ë¡  ì™„ë£Œ í›„, ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
                await engine.chat.completions.create({messages: [], stream: false});


            } catch (error) {
                console.error("WebLLM ì¶”ë¡  ì˜¤ë¥˜:", error);
                llmErrorMessage.textContent = `ì¶”ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                llmErrorMessage.style.display = 'block';
                assistantMessageEl.innerHTML += ' <span style="color: red;">[ì¶”ë¡  ì˜¤ë¥˜]</span>';

            } finally {
                llmInput.disabled = false;
                llmSubmit.disabled = false;
                llmSubmit.textContent = 'ë¶„ì„ ìš”ì²­';
                llmInput.focus();
            }
        });


        // -------------------------------------------------------------
        // 4. ê¸ˆìœµ ì§€ìˆ˜ ë¡œë“œ ë° ê¸°íƒ€ ì´ˆê¸°í™” ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        // -------------------------------------------------------------
        
        async function loadFinanceData() {
            // ì´ ë¶€ë¶„ì€ ì‹¤ì œ ê¸ˆìœµ ì§€ìˆ˜ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
            const tempIndices = [
                { id: 'index-kospi', name: 'KOSPI', í˜„ì¬ê°€: '2,500.00', ì „ì¼ë¹„: '+15.50', ë“±ë½ë¥ : '+0.62%', type: 'up' },
                { id: 'index-kosdaq', name: 'KOSDAQ', í˜„ì¬ê°€: '850.50', ì „ì¼ë¹„: '-5.20', ë“±ë½ë¥ : '-0.61%', type: 'down' },
                { id: 'index-dow', name: 'Dow Jones', í˜„ì¬ê°€: '38,000.00', ì „ì¼ë¹„: '+150.00', ë“±ë½ë¥ : '+0.40%', type: 'up' },
                { id: 'index-nasdaq', name: 'NASDAQ', í˜„ì¬ê°€: '15,000.00', ì „ì¼ë¹„: '-50.00', ë“±ë½ë¥ : '-0.33%', type: 'down' },
            ];

            tempIndices.forEach(index => {
                const card = document.getElementById(index.id);
                if (!card) return;
                
                const valueEl = card.querySelector('.index-value');
                const changeEl = card.querySelector('.index-change');
                
                valueEl.textContent = index.í˜„ì¬ê°€ || 'N/A';
                changeEl.textContent = `${index.ì „ì¼ë¹„ || 'N/A'} (${index.ë“±ë½ë¥  || 'N/A'})`;
                
                changeEl.classList.remove('text-up', 'text-down', 'text-flat');
                const change = parseFloat(index.ì „ì¼ë¹„.replace(/,/g, '').replace('+', ''));
                if (change > 0) changeEl.classList.add('text-up');
                else if (change < 0) changeEl.classList.add('text-down');
                else changeEl.classList.add('text-flat');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadStockMarketData();
            loadFinanceData();
            // í˜ì´ì§€ ë¡œë“œ í›„ WebLLM ëª¨ë¸ ë¡œë“œ ì‹œì‘
            initializeWebLLM(); 
        });

    </script>
</body>
</html>