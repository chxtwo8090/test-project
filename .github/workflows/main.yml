name: Project CI/CD Pipeline

# 1. 트리거: 'main' 브랜치에 코드가 푸시(push)될 때마다 실행
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 2. GitHub 리포지토리의 코드를 내려받음
    - name: Checkout Source Code
      uses: actions/checkout@v3

    # 3. AWS 자격 증명 설정 (GitHub Secrets에 등록한 정보 사용)
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 4. AWS ECR(컨테이너 이미지 저장소)에 로그인
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    # 5. Docker 이미지 빌드 및 ECR로 푸시
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:latest .
        docker build -t $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG .
        docker push $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:latest
        docker push $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG
        echo "::set-output name=image::$ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG"

    # 6. ECS 작업 정의(Task Definition) 파일 생성 (Python 스크립트 방식)
    - name: Create ECS Task Definition
      id: task-def
      # 환경 변수로 시크릿 값들을 Python 스크립트에 전달
      env:
        IMAGE_URL: ${{ steps.build-image.outputs.image }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        TASK_ROLE_ARN: ${{ secrets.ECS_TASK_ROLE_ARN }}
      run: |
        # 1. 현재 작업 정의를 다운로드
        aws ecs describe-task-definition --task-definition ${{ secrets.ECS_TASK_FAMILY }} --query taskDefinition > task-definition.json
        
        # 2. Python 스크립트를 실행하여 JSON 파일 수정
        python -c "
import json, os

# 1. JSON 파일 로드
with open('task-definition.json', 'r') as f:
    task_def = json.load(f)

# 2. 새 이미지 URL 주입
task_def['containerDefinitions'][0]['image'] = os.environ['IMAGE_URL']

# 3. RDS 환경 변수 주입 (app.py용)
task_def['containerDefinitions'][0]['environment'] = [
    {'name': 'DB_HOST', 'value': os.environ['DB_HOST']},
    {'name': 'DB_NAME', 'value': os.environ['DB_NAME']},
    {'name': 'DB_USER', 'value': os.environ['DB_USER']},
    {'name': 'DB_PASSWORD', 'value': os.environ['DB_PASSWORD']}
]

# 4. DynamoDB 접근 권한(Task Role ARN) 주입
task_def['taskRoleArn'] = os.environ['TASK_ROLE_ARN']

# 5. 등록에 불필요한 키들 제거
keys_to_remove = [
    'taskDefinitionArn', 'revision', 'status', 'requiresAttributes', 
    'compatibilities', 'registeredAt', 'registeredBy'
]
for key in keys_to_remove:
    if key in task_def:
        del task_def[key]

# 6. 수정된 JSON을 새 파일로 저장
with open('new-task-definition.json', 'w') as f:
    json.dump(task_def, f)
        "
        
        # 3. 다음 단계에서 사용할 수 있도록 파일 경로 출력
        echo "::set-output name=task_definition_json::new-task-definition.json"

    # 7. 새 작업 정의를 ECS에 등록
    - name: Register ECS Task Definition
      id: register-task
      run: |
        aws ecs register-task-definition --cli-input-json file://${{ steps.task-def.outputs.task_definition_json }} --query taskDefinition.taskDefinitionArn > task-arn.txt
        echo "::set-output name=task_arn::$(cat task-arn.txt)"

    # 8. ECS 서비스 업데이트 (배포)
    - name: Deploy to ECS Service
      run: |
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
          --service ${{ secrets.ECS_SERVICE_NAME }} \
          --task-definition ${{ steps.register-task.outputs.task_arn }} \
          --force-new-deployment