name: Project CI/CD Pipeline

# 1. íŠ¸ë¦¬ê±°: 'main' ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œ(push)ë  ë•Œë§ˆë‹¤ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 2. GitHub ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ë‚´ë ¤ë°›ìŒ
    - name: Checkout Source Code
      uses: actions/checkout@v3

    # 3. AWS ìê²© ì¦ëª… ì„¤ì •
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 4. AWS ECR(ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì €ì¥ì†Œ)ì— ë¡œê·¸ì¸
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECRë¡œ í‘¸ì‹œ
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:latest .
        docker build -t $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG .
        docker push $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:latest
        docker push $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG
        echo "::set-output name=image::$ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG"

    # 6. ECS ì‘ì—… ì •ì˜(Task Definition) íŒŒì¼ ìƒì„± ë° ìˆ˜ì •
    - name: Fill in the new image ID in the ECS task definition
      id: task-def
      run: |
        # ğŸ›‘ [ìˆ˜ì •] Task Family ì´ë¦„ 'project-app-task'ë¥¼ ì§ì ‘ ì‚¬ìš©
        aws ecs describe-task-definition --task-definition "project-app-task" --query taskDefinition > task-definition.json

        IMAGE_URL=${{ steps.build-image.outputs.image }}

        # ------------------------------------------------------------------
        # ğŸ›‘ [ìˆ˜ì •] command í•„ë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚½ì… (Gunicorn CORS ì˜µì…˜ í¬í•¨)
        # ------------------------------------------------------------------
        # JSON ë°°ì—´ ë¬¸ìì—´ (Gunicorn ëª…ë ¹)
        COMMAND_ARRAY='["gunicorn", "--bind", "0.0.0.0:80", "--header", "Access-Control-Allow-Origin: *", "--header", "Access-Control-Allow-Credentials: true", "app:app"]'

        # jq ëª…ë ¹: ì´ë¯¸ì§€, í™˜ê²½ ë³€ìˆ˜, ê·¸ë¦¬ê³  command í•„ë“œë¥¼ ì—…ë°ì´íŠ¸
        jq --arg IMAGE_URL "$IMAGE_URL" \
           --arg DB_HOST "${{ secrets.DB_HOST }}" \
           --arg DB_NAME "${{ secrets.DB_NAME }}" \
           --arg DB_USER "${{ secrets.DB_USER }}" \
           --arg DB_PASSWORD "${{ secrets.DB_PASSWORD }}" \
           --argjson COMMAND_ARRAY "$COMMAND_ARRAY" \
           '.containerDefinitions[0].image = $IMAGE_URL |
            .containerDefinitions[0].command = $COMMAND_ARRAY |  # â¬…ï¸ command í•„ë“œ ì‚½ì…
            .containerDefinitions[0].environment = [
              {"name": "DB_HOST", "value": $DB_HOST},
              {"name": "DB_NAME", "value": $DB_NAME},
              {"name": "DB_USER", "value": $DB_USER},
              {"name": "DB_PASSWORD", "value": $DB_PASSWORD}
            ] |
            del(.taskDefinitionArn) | 
            del(.revision) | 
            del(.status) | 
            del(.requiresAttributes) | 
            del(.compatibilities) | 
            del(.registeredAt) | 
            del(.registeredBy)' \
           task-definition.json > new-task-definition.json
        
        echo "::set-output name=task_definition_json::new-task-definition.json"

    # 7. ìƒˆ ì‘ì—… ì •ì˜ë¥¼ ECSì— ë“±ë¡
    - name: Register ECS Task Definition
      id: register-task
      run: |
        aws ecs register-task-definition --cli-input-json file://${{ steps.task-def.outputs.task_definition_json }} --query taskDefinition.taskDefinitionArn > task-arn.txt
        echo "::set-output name=task_arn::$(cat task-arn.txt)"

    # 8. ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (ë°°í¬)
    - name: Deploy to ECS Service
      run: |
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
          --service ${{ secrets.ECS_SERVICE_NAME }} \
          --task-definition ${{ steps.register-task.outputs.task_arn }} \
          --force-new-deployment