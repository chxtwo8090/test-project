name: Project CI/CD Pipeline

# 1. 트리거: 'main' 브랜치에 코드가 푸시(push)될 때마다 실행
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 2. GitHub 리포지토리의 코드를 내려받음
    - name: Checkout Source Code
      uses: actions/checkout@v3

    # 3. AWS 자격 증명 설정 (GitHub Secrets에 등록한 정보 사용)
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 4. AWS ECR(컨테이너 이미지 저장소)에 로그인
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    # 5. Docker 이미지 빌드 및 ECR로 푸시
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:latest .
        docker build -t $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG .
        docker push $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:latest
        docker push $ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG
        echo "::set-output name=image::$ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG"

    # 6. ECS 작업 정의(Task Definition) 파일 생성
   
    - name: Create ECS Task Definition
      id: task-def
      run: |
        aws ecs describe-task-definition --task-definition ${{ secrets.ECS_TASK_FAMILY }} --query taskDefinition > task-definition.json
        
        # 셸 스크립트(jq)를 사용하여 JSON 파일 수정
        # 1. 'image' 키 값을 새 이미지 URL로 변경
        # 2. 'environment' 키에 DB 접속 정보(시크릿) 추가
        # 3. 호환되지 않는 키(status, compatibilities 등) 제거
        jq --arg IMAGE_URL ${{ steps.build-image.outputs.image }} \
           --arg DB_HOST ${{ secrets.DB_HOST }} \
           --arg DB_NAME ${{ secrets.DB_NAME }} \
           --arg DB_USER ${{ secrets.DB_USER }} \
           --arg DB_PASSWORD ${{ secrets.DB_PASSWORD }} \
           --arg ECS_CONTAINER_NAME ${{ secrets.ECS_CONTAINER_NAME }} \
           '.containerDefinitions[0].image = $IMAGE_URL | 
            .containerDefinitions[0].environment = [
              {"name": "DB_HOST", "value": $DB_HOST},
              {"name": "DB_NAME", "value": $DB_NAME},
              {"name": "DB_USER", "value": $DB_USER},
              {"name": "DB_PASSWORD", "value": $DB_PASSWORD}
            ] | 
            del(.taskDefinitionArn) | 
            del(.revision) | 
            del(.status) | 
            del(.requiresAttributes) | 
            del(.compatibilities) | 
            del(.registeredAt) | 
            del(.registeredBy)' \
           task-definition.json > new-task-definition.json
        
        echo "::set-output name=task_definition_json::new-task-definition.json"

    # 7. 새 작업 정의를 ECS에 등록
    - name: Register ECS Task Definition
      id: register-task
      run: |
        aws ecs register-task-definition --cli-input-json file://${{ steps.task-def.outputs.task_definition_json }} --query taskDefinition.taskDefinitionArn > task-arn.txt
        echo "::set-output name=task_arn::$(cat task-arn.txt)"

    # 8. ECS 서비스 업데이트 (배포)
 
    - name: Deploy to ECS Service
      run: |
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
          --service ${{ secrets.ECS_SERVICE_NAME }} \
          --task-definition ${{ steps.register-task.outputs.task_arn }} \
          --force-new-deployment