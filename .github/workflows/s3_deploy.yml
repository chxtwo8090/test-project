name: Frontend S3 Deployment

# 1. 트리거: 'main' 브랜치에 푸시가 발생할 때 실행
on:
  push:
    branches:
      - main
  # workflows/main.yml (백엔드 배포)와 동시에 실행됩니다.

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 2. GitHub 리포지토리의 코드를 내려받음 
    - name: Checkout Source Code
      uses: actions/checkout@v3

    # 3. AWS 자격 증명 설정 (Secrets 재사용)
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 4. S3 버킷에 파일 동기화 (배포)
    - name: Deploy static files to S3 bucket
      run: |
        # S3 동기화 명령어
        # 'sync'는 변경된 파일만 업로드하고, S3에는 없는 로컬 파일을 삭제합니다.
        # --delete 옵션을 사용하면 S3에 있지만 로컬에 없는 파일은 삭제됩니다.
        aws s3 sync . s3://chxtwo-git/ \
          --exclude ".github/*" \
          --exclude "terraform/*" \
          --exclude "app.py" \
          --exclude "requirements.txt" \
          --exclude "node_modules/*" \
          --delete
        
        # [중요] 배포 후, 브라우저가 새 파일을 즉시 로드하도록 캐시 무효화 (Invalidation) 요청
        # CloudFront를 사용하지 않으므로 이 단계는 생략합니다.
        echo "✅ Frontend files synchronized to S3 bucket: chxtwo-git"