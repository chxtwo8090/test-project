<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ì¦ì‹œ í´ë¡  - ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„ í”Œë«í¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” ë° í°íŠ¸ ì„¤ì • (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
        body {
            font-family: 'Naver NanumGothic', 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7; /* ë„¤ì´ë²„ ë°°ê²½ìƒ‰ê³¼ ìœ ì‚¬ */
            color: #1c1c1c;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
        header {
            background-color: #fff;
            border-bottom: 1px solid #ebebeb;
            padding: 10px 0;
        }
        .header-content {
            width: 1080px; /* ë„¤ì´ë²„ í‘œì¤€ ë„ˆë¹„ */
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo a {
            font-size: 24px;
            font-weight: bold;
            color: #008850; /* ë„¤ì´ë²„ ê·¸ë¦° */
            text-decoration: none;
        }
        nav a {
            margin-left: 20px;
            text-decoration: none;
            color: #1c1c1c;
            font-weight: 500;
        }

        /* ë©”ì¸ ì»¨í…ì¸  ë ˆì´ì•„ì›ƒ (LLM ì±—ë´‡ì„ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜í•˜ê¸° ìœ„í•´ gridë¡œ ë³€ê²½) */
        main {
            width: 1080px;
            margin: 20px auto;
            display: grid; 
            grid-template-columns: 2fr 1fr; /* ë°ì´í„° í…Œì´ë¸”(2)ê³¼ ì±—ë´‡(1) */
            gap: 20px;
        }

        .data-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* í‘œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
        #stock-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 15px;
        }
        #stock-data-table th, #stock-data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        #stock-data-table th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #444;
        }
        #stock-data-table tr:hover {
            background-color: #f0f8ff;
        }
        .text-right { text-align: right; }

        /* ì±—ë´‡ ìŠ¤íƒ€ì¼ (ì¶”ê°€ë¨) */
        .chatbot-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            max-height: 80vh; 
        }
        .chat-output {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 6px;
            background-color: #fcfcfc;
            white-space: pre-wrap;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .user-message {
            color: #007bff;
            font-weight: 500;
        }
        .llm-message {
            color: #008850;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo"><a href="index.html">ì°¬ê·œ's ê¸ˆìœµ</a></div>
            <nav>
                <a href="index.html">ê²Œì‹œíŒ</a>
                <a href="finance.html" style="color: #008850;">ê¸ˆìœµ ë¶„ì„</a>
                <a id="auth-link" href="login.html">ë¡œê·¸ì¸</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="data-section">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© í˜„í™©</h2>
            <div id="loading-indicator" class="text-center text-gray-500 py-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <table id="stock-data-table">
                <thead>
                    <tr>
                        <th>ì¢…ëª©ëª…</th>
                        <th class="text-right">í˜„ì¬ê°€</th>
                        <th class="text-right">ì „ì¼ë¹„</th>
                        <th class="text-right">ë“±ë½ë¥ </th>
                        <th class="text-right">ì‹œê°€ì´ì•¡(ì–µ)</th>
                    </tr>
                </thead>
                <tbody id="stock-data-body">
                    </tbody>
            </table>
        </div>

        <div class="chatbot-section">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">AI ê¸ˆìœµ ë¶„ì„ ì±—ë´‡ (Gemma 3N)</h2>
            <div id="llm-chat-output" class="chat-output text-sm">
                <span class="llm-message">ì•ˆë…•í•˜ì„¸ìš”! gemma-3n-E4B-it ê¸°ë°˜ì˜ ê¸ˆìœµ ë¶„ì„ ì±—ë´‡ì…ë‹ˆë‹¤. í˜„ì¬ í˜ì´ì§€ì˜ ì¢…ëª© ë°ì´í„°ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.</span>
            </div>
            <form id="llm-chat-form" class="flex mt-auto">
                <input type="text" id="llm-prompt-input" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
                <button type="submit" id="llm-submit-button" class="bg-blue-600 text-white p-3 rounded-r-lg hover:bg-blue-700 transition duration-150">ì „ì†¡</button>
            </form>
            <div id="llm-error-message" class="text-red-500 text-sm mt-2 hidden"></div>
        </div>
    </main>

    <script>
        // ğŸ”‘ ALBì˜ DNS ì£¼ì†Œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤. Fargate LLM APIì˜ ë² ì´ìŠ¤ URLì…ë‹ˆë‹¤.
        const API_URL = 'http://api.chxtwo.kro.kr'; // ì˜ˆì‹œ ì£¼ì†Œ

        // ----------------------------------------------------
        // 1. í¬ë¡¤ë§ ë°ì´í„° ë¡œë”© (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        // ----------------------------------------------------
        async function loadStockData() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const tableBody = document.getElementById('stock-data-body');
            
            // ì´ˆê¸° ì±—ë´‡ ë©”ì‹œì§€ë¥¼ ì €ì¥í•´ë‘¡ë‹ˆë‹¤.
            const initialChatOutput = llmChatOutput.innerHTML; 

            try {
                // ê¸°ì¡´ Flask API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ (ì›¹ í¬ë¡¤ë§ ë°ì´í„°)
                const response = await fetch(`${API_URL}/api/finance/top-stocks`); 
                if (!response.ok) {
                    throw new Error('API ì‘ë‹µ ì‹¤íŒ¨');
                }
                const data = await response.json();

                if (data.error) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500">${data.error}: ${data.message}</td></tr>`;
                    return;
                }

                tableBody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
                
                // LLMì—ê²Œ ì œê³µí•  ë°ì´í„°ë¥¼ í¬ë§·íŒ…
                let dataForLLM = "í˜„ì¬ ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© ë°ì´í„°:\n";
                dataForLLM += "ìˆœìœ„ | ì¢…ëª©ëª… | í˜„ì¬ê°€ | ì „ì¼ë¹„ | ë“±ë½ë¥  | ì‹œê°€ì´ì•¡(ì–µ)\n";

                data.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = item['ì¢…ëª©ëª…'] || 'N/A';
                    row.insertCell().textContent = item['í˜„ì¬ê°€']?.toLocaleString() || 'N/A';
                    
                    const changeCell = row.insertCell();
                    changeCell.textContent = item['ì „ì¼ë¹„']?.toLocaleString() || 'N/A';
                    
                    const rateCell = row.insertCell();
                    const rate = parseFloat(item['ë“±ë½ë¥ ']?.replace('%', '') || 0);
                    rateCell.textContent = item['ë“±ë½ë¥ '] || '0.00%';
                    rateCell.classList.add('text-right');
                    rateCell.style.color = rate > 0 ? '#ff0000' : (rate < 0 ? '#0000ff' : '#1c1c1c');

                    row.insertCell().textContent = item['ì‹œê°€ì´ì•¡(ì–µ)']?.toLocaleString() || 'N/A';
                    row.cells[1].classList.add('text-right');
                    row.cells[3].classList.add('text-right');
                    row.cells[4].classList.add('text-right');
                    
                    // LLM ë°ì´í„°ì— ì¶”ê°€
                    dataForLLM += `${index + 1} | ${item['ì¢…ëª©ëª…']} | ${item['í˜„ì¬ê°€']} | ${item['ì „ì¼ë¹„']} | ${item['ë“±ë½ë¥ ']} | ${item['ì‹œê°€ì´ì•¡(ì–µ)']}\n`;
                });
                
                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•˜ì—¬ ì±—ë´‡ ë¡œì§ì—ì„œ ì‚¬ìš©
                window.StockDataForLLM = dataForLLM; 

            } catch (error) {
                console.error("ì£¼ì‹ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500">ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</td></tr>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                llmChatOutput.innerHTML = initialChatOutput; // ë¡œë”© ì™„ë£Œ í›„ ì±—ë´‡ ì´ˆê¸° ë©”ì‹œì§€ ë³µêµ¬
            }
        }

        // ----------------------------------------------------
        // 2. LLM ì±—ë´‡ ê¸°ëŠ¥ (ì‹ ê·œ ì¶”ê°€)
        // ----------------------------------------------------
        const llmChatForm = document.getElementById('llm-chat-form');
        const llmPromptInput = document.getElementById('llm-prompt-input');
        const llmChatOutput = document.getElementById('llm-chat-output');
        const llmSubmitButton = document.getElementById('llm-submit-button');
        const llmErrorMessage = document.getElementById('llm-error-message');

        function updateChatDisplay(role, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-3', 'p-2', 'rounded-lg', 'break-words');
            
            if (role === 'user') {
                messageElement.innerHTML = `<span class="user-message font-semibold">ë‚˜:</span> ${message}`;
                messageElement.style.textAlign = 'right';
                messageElement.style.backgroundColor = '#e6f3ff';
            } else {
                messageElement.innerHTML = `<span class="llm-message font-semibold">ë¶„ì„ê°€:</span> ${message}`;
                messageElement.style.textAlign = 'left';
                messageElement.style.backgroundColor = '#f0fff0';
            }
            llmChatOutput.appendChild(messageElement);
            llmChatOutput.scrollTop = llmChatOutput.scrollHeight;
        }

        llmChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userPrompt = llmPromptInput.value.trim();
            if (!userPrompt) return;

            updateChatDisplay('user', userPrompt);
            llmErrorMessage.classList.add('hidden');

            llmPromptInput.value = '';
            llmPromptInput.disabled = true;
            llmSubmitButton.disabled = true;
            llmSubmitButton.textContent = 'ë¶„ì„ ì¤‘...';

            const llmApiUrl = `${API_URL}/llm/chat`; // LLM API ì—”ë“œí¬ì¸íŠ¸

            // í¬ë¡¤ë§ ë°ì´í„°ë¥¼ í¬í•¨í•˜ì—¬ ì „ì²´ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
            const fullPrompt = `ë‹¤ìŒ ë°ì´í„°ë¥¼ ì°¸ê³ í•˜ì—¬ ì‚¬ìš©ì ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”:\n\n${window.StockDataForLLM || "í˜„ì¬ ë¡œë”©ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."}\n\nì‚¬ìš©ì ì§ˆë¬¸: ${userPrompt}`;

            try {
                const response = await fetch(llmApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt }) // LLM APIì— ì „ì²´ í”„ë¡¬í”„íŠ¸ ì „ì†¡
                });
                
                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.error || `API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }

                const result = await response.json();
                const llmResponse = result.response;
                
                updateChatDisplay('llm', llmResponse);
                
            } catch (error) {
                console.error("LLM API ì˜¤ë¥˜:", error);
                llmErrorMessage.textContent = `ì±—ë´‡ ì˜¤ë¥˜: ${error.message} (LLM ì„œë²„ ìƒíƒœ í™•ì¸ í•„ìš”)`;
                llmErrorMessage.classList.remove('hidden');
            } finally {
                llmPromptInput.disabled = false;
                llmSubmitButton.disabled = false;
                llmSubmitButton.textContent = 'ì „ì†¡';
                llmPromptInput.focus();
            }
        });


        // ----------------------------------------------------
        // 3. ì´ˆê¸°í™” ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        // ----------------------------------------------------
        function updateAuthUI() {
            // ì¸ì¦ ë¡œì§ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ê´€ë¦¬)
            const authToken = localStorage.getItem('authToken');
            const authLink = document.getElementById('auth-link');
            if (authToken) {
                authLink.textContent = 'ë¡œê·¸ì•„ì›ƒ';
                authLink.href = '#'; 
                authLink.onclick = () => {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('loggedInUserId');
                    localStorage.removeItem('loggedInNickname');
                    window.location.reload();
                };
            } else {
                authLink.textContent = 'ë¡œê·¸ì¸';
                authLink.href = 'login.html';
                authLink.onclick = null;
            }
        }

        window.onload = function() {
            updateAuthUI();
            loadStockData();
        };
    </script>
</body>
</html>